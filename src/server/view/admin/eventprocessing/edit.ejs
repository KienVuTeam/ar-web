<!-- breack-crum -->
<div class="page-header">
  <div class="page-block">
    <div class="row align-items-center">
      <div class="col-md-12">
        <div class="page-header-title">
          <h5 class="m-b-10">Event</h5>
        </div>
        <ul class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="/admin/eventprocessing/">list</a>
          </li>
          <li class="breadcrumb-item"><a href="#!">edit</a></li>
          <!-- <li class="breadcrumb-item" aria-current="page">Home</li> -->
        </ul>
      </div>
    </div>
  </div>
</div>
<!-- breack-crum -->
<%- include('./headcontrolpartial')%>
<!-- <h2>Edit Event</h2> -->
<link rel="stylesheet" href="/css/my_gallery.css">
<script src="/admin/assets/js/plugins/tinymce/tinymce.min.js"></script>

<style>
    .form-container {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 900px;
      margin: auto;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    h2 {
      color: #007bff;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
    }
    input[type="text"],
    input[type="datetime-local"],
    select,
    textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .date-range {
      display: flex;
      gap: 10px;
    }
    .date-range input {
      flex: 1;
    }
    .btn-media {
      background: #6c63ff;
      color: #fff;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-media:hover {
      background: #5848d6;
    }
    .careful{
      color: red;
    }
  </style>
  
  <!--  -->

  
  <div class="row">
    <div class="col-8">
      <div class="card">
        <div class="card-body">
          <!--  -->
          <div class="form-group">
            <label for="event-name" >T√™n s·ª± ki·ªán <small class="careful">(*)</small></label>
            <input type="text" id="title" name="title" placeholder="Nh·∫≠p t√™n s·ª± ki·ªán" value="<%=event.name%>" />
          </div>
          <div class="form-group">
          <label for="">Description </label>
          <textarea name="" id="desc" cols="30" rows="3" placeholder="Nh·∫≠p m√¥ t·∫£"><%=event.desc%></textarea>
        </div>
  
          <div class="form-group">
            <label for="event-link">Link <small>T·ª± ƒë·ªông c√≥ theo t√™n s·ª± ki·ªán</small></label>
            <input type="text" id="slug" name="slug" placeholder="Nh·∫≠p link" value="<%=event.slug%>" />
          </div>
  
          <div class="form-group">
            <label>Th·ªùi gian s·ª± ki·ªán <small class="careful">(*)</small></label>
            <div class="date-range">
              <input class="form-control" type="date" name="startDate" id="startDate"   value="<%=event.startDate%>" />
              <input class="form-control" type="date" name="endDate" id="endDate" value="<%=event.endDate%>"/>
            </div>
          </div>
  
          <div class="form-group">
            <label>Th·ªùi gian ƒë√≥ng ·ªßy quy·ªÅn <small class="careful">(*)</small></label>
            <input class="form-control" type="date" name="authorityDate" id="authorityDate" value="<%=event.authorityDate%>" />
          </div>
  
          <br />
          <!-- content 2 -->
          <div class="form-group">
            <label>N·ªôi dung gi·ªõi thi·ªáu </label>
            <!-- <button class="btn-media">Th√™m media</button> <br /> <br> -->
            <!-- <label for=""></label> -->
            <textarea id="event-tinymce-4" name="event-tinymce-4" class="tox-target" placeholder="Write here"><%= event.content %></textarea>
          </div>
  
          <div class="form-group">
            <label for="api-chipt">API chiptime</label>
            <input type="text" id="apiLink" name="apiLink" placeholder="Nh·∫≠p API chiptime" value="<%=event.apiLink%>"/>
          </div>
  
          <div class="form-group w-50">
            <label for="rank-type">L·∫•y x·∫øp h·∫°ng theo <small>(*)</small></label>
            <select id="rankType">
                <option value="1" <%= event.rankType ? 'selected="selected"' : '' %>>Gun time</option>
                <option value="0" <%= !event.rankType ? 'selected="selected"' : '' %>>Net time</option>

            </select>
          </div>

        </div>
        <div class="card-footer">
          <button id="eventSubmit" type="button" class="btn btn-primary">Update Event</button>
          <input type="hidden"  value="<%=event._id%>" id="idObject">
        </div>
      </div>
    </div>
    <!-- haft -->
    <div class="col-4">
      <div class="card">
        <div class="card-body">
          <div class="form-group">
            <!-- <label for="">hi·ªán tr√™n web</label> -->
            <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="isShow" name="isActive" <%= event.isShow ? 'checked' : '' %>  />
            <label class="form-check-label" for="isActive">Hi·ªán tr√™n web</label>
          </div>
          </div>
          <div class="form-group">
            <label for="" class="form-label" >Place <small class="careful">(*)</small></label>
            <input type="text" id="event-place" value="<%=event.place%>">
            <input type="hidden" id="eventStatus" value="<%=event.status%>">

          </div>
          <!-- Thumb -->
        <label class="form-label">Thumb (700x420) <small style="color: red;">(*)</small></label>
        <div class="img_preview" id="img_preview_thumb">
          <img loading="lazy" src="<%=event && event.image_thumb ? event.image_thumb : '' %>" alt="" loading="lazy">
          <input id="img_path_thumb" value="<%=event && event.image_thumb ? event.image_thumb : '' %>" type="hidden">
        </div>
        <div class="form-group mb-3">
          <button class="btn btn-outline-info btn-choose-image" data-target="thumb" data-bs-toggle="modal"
            data-bs-target="#exampleModal">Choose image</button>
        </div>

        <!-- Banner -->
        <label class="form-label">Banner (1800x600) <small style="color: red;">(*)</small></label>
        <div class="img_preview" id="img_preview_banner">
          <img loading="lazy" src="<%=event && event.image_banner ? event.image_banner : '' %>" alt="" loading="lazy">
          <input id="img_path_banner" value="<%=event && event.image_banner ? event.image_banner : '' %>" type="hidden">
        </div>
        <div class="form-group mb-3">
          <button class="btn btn-outline-info btn-choose-image" data-target="banner" data-bs-toggle="modal"
            data-bs-target="#exampleModal">Choose image</button>
        </div>

        <!-- Certificate Athlete -->
        <label class="form-label"><small>Certificate Athlete(2400x1700)</small>: <small style="color: red;">(*)</small></label>
        <div class="img_preview" id="img_preview_a_certificate">
          <img loading="lazy" src="<%=event && event.image_a_cert ? event.image_a_cert : '' %>" alt="" loading="lazy">
          <input id="img_path_a_certificate" value="<%=event && event.image_a_cert ? event.image_a_cert : '' %>" type="hidden">
        </div>
        <div class="form-group mb-3">
          <button class="btn btn-outline-info btn-choose-image" data-target="a_certificate" data-bs-toggle="modal"
            data-bs-target="#exampleModal">Choose image</button>
        </div>
        <!-- Certificate Volunteer -->
        <!-- <label class="form-label"><small>Certificate Volunteer</small>: <small style="color: red;">(*)</small></label>
        <div class="img_preview" id="img_preview_v_certificate">
          <img loading="lazy" src="<%=event && event.image_v_cert ? event.image_v_cert : '' %>" alt="" loading="lazy">
          <input id="img_path_v_certificate" value="" type="hidden">
        </div>
        <div class="form-group mb-3">
          <button class="btn btn-outline-info btn-choose-image" data-target="v_certificate" data-bs-toggle="modal"
            data-bs-target="#exampleModal">Choose image</button>
        </div> -->
          <!--  -->
          <button id="secondEventSubmit" class="btn btn-primary" >Update Event</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- [Script start] -->
   
   <script>
    function MyInitialTinymce() {
    // üî• Kh·ªüi t·∫°o TinyMCE l·∫°i
    if (typeof tinymce !== "undefined") {
      tinymce.remove(); // xo√° instance c≈© ƒë·ªÉ tr√°nh l·ªói
      tinymce.init({
        height: "300",
        selector: "#event-tinymce-4",
        content_style: 'body { font-family: "Inter", sans-serif; }',
        menubar: false,
        toolbar: [
          "styleselect fontselect fontsizeselect",
          "undo redo | cut copy paste | bold italic | link image | alignleft aligncenter alignright alignjustify",
          "bullist numlist | outdent indent | blockquote subscript superscript | advlist | autolink | lists charmap | print preview |  code",
        ],
        plugins: "advlist autolink link image lists charmap print preview code",
      });
    }
  }
  MyInitialTinymce();
  //   query hien thi img bi display: none
  // T√¨m t·∫•t c·∫£ kh·ªëi preview ·∫£nh
  document.querySelectorAll(".img_preview").forEach(preview => {
    const img = preview.querySelector("img");
    if (!img) return;

    if (img.getAttribute("src") && img.getAttribute("src").trim() !== "") {
      // C√≥ ·∫£nh th√¨ hi·ªÉn th·ªã kh·ªëi
      preview.style.display = "block";
    } else {
      // Kh√¥ng c√≥ ·∫£nh th√¨ ·∫©n
      preview.style.display = "none";
    }
  });
    // 
    function eventSubmitHandle(){
      // alert("hekl")
      const idEvent =$('#idObject').val();
      console.log('id '+idEvent)
      const title = $('#title').val();
      const desc = $('#desc').val();
      const slug = $("#slug").val();
      const editor = tinymce.get('event-tinymce-4');
      const content = editor ? editor.getContent() : $('#event-tinymce-4').val();
      // const content = tinymce.get('event-tinymce-4').getContent();
      const img_thumb= document.getElementById('img_path_thumb').value;
      const img_banner = document.getElementById('img_path_banner').value;
      // const img_v_certificate = document.getElementById('img_path_v_certificate').value;
      const img_a_certificate = document.getElementById('img_path_a_certificate').value;
      const startDate = $('#startDate').val();
      const endDate = $('#endDate').val();
      const authorityDate = $('#authorityDate').val();
      const imagePath = $('#imgPath').val();
      const rankType = $('#rankType').val();
      const eventStatus = $('#eventStatus').val();
      const apiLink = $('#apiLink').val();
      const place = $('#event-place').val();
      const isShow =$('#isShow').is(':checked');
      const dataSend={
        title,
        desc,
        img_thumb,
        img_banner,
        img_a_certificate,
        slug,
        content,
        startDate,
        endDate,
        authorityDate,
        imagePath,
        rankType,
        eventStatus,
        apiLink,
        place,
        isShow
      }
      //test
      // console.log(title, slug, content, startDate, endDate, authorityDate, imagePath, rankType, apiLink, place, isShow, idEvent);
      console.log(dataSend);
      $.ajax({
        url: `/admin/eventprocessing/${idEvent}/update`, 
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(dataSend),
        success: (res)=>{
          if(res.status){
            window.location.href = `/admin/eventprocessing/event-detail/${idEvent}`;
          }
          console.log(res);
        },
        error: (err)=>{
          console.log(err);
        }
      })
    }

    $('#eventSubmit').on('click', function(){
      // alert("click")
      eventSubmitHandle();
      
    });
    $("#secondEventSubmit").on('click', function(){
      // alert("update event 2")
      eventSubmitHandle();
    })

</script>
<!--  -->
<!--gallery  -->

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const modalEl = document.getElementById("exampleModal");
    let currentTarget = null; // l∆∞u block n√†o ƒëang ch·ªçn ·∫£nh

    // B·∫Øt s·ª± ki·ªán click v√†o c√°c n√∫t "Choose image"
    document.querySelectorAll(".btn-choose-image").forEach(btn => {
      btn.addEventListener("click", function () {
        currentTarget = this.dataset.target; // thumb, banner, certificate
      });
    });
    if (modalEl) {
      modalEl.addEventListener("shown.bs.modal", function () {
        const galleryRoot = document.getElementById("galleryRoot");
        galleryRoot.innerHTML = ""; // clear c≈©
        MediaGallery.init(galleryRoot, {
          onSelect: (img) => {
            if (!currentTarget) return;
            document.getElementById("img_preview_"+currentTarget).style.display = "block";
            const preview = document.getElementById("img_preview_" + currentTarget);
            const input = document.getElementById("img_path_" + currentTarget);

            preview.querySelector("img").src = img.url;
            input.value = img.url;

            // ƒë√≥ng modal
            const closeBtn = modalEl.querySelector("[data-bs-dismiss='modal']");
            if (closeBtn) closeBtn.click();
          },
        });
      });
    }
  });

</script>

<!-- [Modal area] -->


<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen" style="max-height: 95%; max-width: 95%; margin: 20px auto;">
    <div class="modal-content">
      <!-- <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title A</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div> -->
      <div class="modal-body">
        <!-- start -->
        <div id="galleryRoot"></div>
        <!-- end -->
      </div>
      <div class="modal-footer">
        <!-- <button type="button" class="btn btn-secondary" hidden data-bs-dismiss="modal">Close</button> -->
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
      </div>
    </div>
  </div>
</div>
<!-- [End modal area] -->

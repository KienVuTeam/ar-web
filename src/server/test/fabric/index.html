<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Konva Drag TextBox with Fixed Fields</title>
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    #container { border: 1px solid #ccc; margin: 10px auto; display: block; }
    button, input { margin: 5px; }
  </style>
</head>
<body>
  <h2>KÃ©o tháº£ Text-Box cá»‘ Ä‘á»‹nh + thÃªm má»›i</h2>
  <div>
    <button id="addText">â• ThÃªm Text</button>
    <button id="saveData">ğŸ’¾ LÆ°u tá»a Ä‘á»™</button>
    <button id="exportImg">ğŸ“· Xuáº¥t áº£nh</button>
    <label>
      Font-size:
      <input type="number" id="fontSizeInput" min="8" max="100" value="20" style="width:60px;">
    </label>
  </div>
  <div id="container"></div>

  <script>
    // 1. Khá»Ÿi táº¡o stage + layer
    const stage = new Konva.Stage({
      container: "container",
      width: 800,
      height: 600,
    });
    const layer = new Konva.Layer();
    stage.add(layer);

    // 2. Load áº£nh ná»n
    const background = new Konva.Image({
      x: 0,
      y: 0,
      width: stage.width(),
      height: stage.height(),
    });
    layer.add(background);

    const imageObj = new Image();
    imageObj.onload = function () {
      background.image(imageObj);
      layer.draw();
    };
    imageObj.src = "https://picsum.photos/800/600"; // ğŸ‘‰ Ä‘á»•i áº£nh template

    let selectedTextNode = null; // text Ä‘ang Ä‘Æ°á»£c chá»n Ä‘á»ƒ chá»‰nh font

    // 3. Function táº¡o text-box (cÃ³ fieldName Ä‘á»ƒ mapping vá»›i DB)
    function createTextBox(fieldName, text, x = 50, y = 50, isFixed = false, fontSize = 20) {
      const textNode = new Konva.Text({
        text: text,
        x: x,
        y: y,
        fontSize: fontSize,
        draggable: true,
        fill: "red",
        name: fieldName, // Ä‘á»ƒ mapping vá»›i DB
        ellipsis: true,  // náº¿u dÃ i quÃ¡ thÃ¬ thÃªm "..."
        wrap: "word"
      });

      // Chá»n text Ä‘á»ƒ chá»‰nh font-size
      textNode.on("click", () => {
        selectedTextNode = textNode;
        document.getElementById("fontSizeInput").value = textNode.fontSize();
      });

      // Cho phÃ©p sá»­a text náº¿u KHÃ”NG pháº£i field cá»‘ Ä‘á»‹nh
      if (!isFixed) {
        textNode.on("dblclick", () => {
          const newText = prompt("Nháº­p text:", textNode.text());
          if (newText) textNode.text(newText);
          layer.draw();
        });
      }

      layer.add(textNode);
      layer.draw();
    }

    // 4. Táº¡o sáºµn cÃ¡c text-box cá»‘ Ä‘á»‹nh (mapping DB field)
    const fixedFields = [
      { field: "name", label: "TÃªn" },
      { field: "dob", label: "NgÃ y sinh" },
      { field: "address", label: "Äá»‹a chá»‰" },
      { field: "email", label: "Email" },
    ];

    fixedFields.forEach((f, i) => {
      createTextBox(f.field, f.label, 50, 50 + i * 40, true);
    });

    // 5. ThÃªm text-box custom
    document.getElementById("addText").addEventListener("click", () => {
      createTextBox("custom_" + Date.now(), "Text má»›i");
    });

    // 6. Thay Ä‘á»•i font-size khi nháº­p input
    document.getElementById("fontSizeInput").addEventListener("input", (e) => {
      if (selectedTextNode) {
        selectedTextNode.fontSize(parseInt(e.target.value, 10));
        layer.draw();
      }
    });

    // 7. LÆ°u data (bao gá»“m fieldName Ä‘á»ƒ biáº¿t mapping DB + fontSize)
    document.getElementById("saveData").addEventListener("click", () => {
      const data = [];
      layer.find("Text").forEach((t) => {
        data.push({
          field: t.name(),  // field trong DB
          text: t.text(),   // text hiá»‡n táº¡i (label)
          x: t.x(),
          y: t.y(),
          fontSize: t.fontSize(),
          fill: t.fill(),
        });
      });
      console.log("Data lÆ°u:", data);
      alert("Check console Ä‘á»ƒ xem JSON data (lÆ°u vÃ o DB).");
    });

    // 8. Xuáº¥t áº£nh
    document.getElementById("exportImg").addEventListener("click", () => {
      const dataURL = stage.toDataURL({ pixelRatio: 2 });
      const link = document.createElement("a");
      link.download = "output.png";
      link.href = dataURL;
      link.click();
    });
  </script>
</body>
</html>
